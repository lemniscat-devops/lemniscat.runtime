tasks:
- task: azurecli
  displayName: 'Check if workspace exist'
  steps:
    - pre
  parameters:
    scripttype: pwsh
    commandtype: inline
    script: | 
      $rg_name = "${{ nc.rgName }}"
      $workspaceExist = az group exists -n $rg_name 
      if($workspaceExist -eq "false") 
      { 
          Write-Host "The resource group named $rg_name not exist." 
      } 
      else{ 
          Write-Host "The resource group named $rg_name exist, skipping creation!" 
      } 
      Write-Host "[lemniscat.pushvar] workspaceExist=$workspaceExist"

- task: terraform
  condition: '"${{ workspaceExist }}" == "false"'
  displayName: 'Terraform init'
  steps:
    - pre
  parameters:
    action: init
    tfPath: C:\DEV\Onepoint\Smartplace\Infra.Templates\terraform\workspace
    backend:
      key: "${{ nc.rgName }}.azureworkspace.tfstate"
- task: terraform
  condition: '"${{ workspaceExist }}" == "false"'
  displayName: 'Terraform plan workspace'
  steps:
    - pre
  parameters:
    action: plan
    tfPath: C:\DEV\Onepoint\Smartplace\Infra.Templates\terraform\workspace
    tfVarFile: C:\DEV\Onepoint\lemniscat\github\lemniscat.runtime\sample\variables.tfvars.json
- task: terraform
  condition: '"${{ workspaceExist }}" == "false"'
  displayName: 'Terraform apply workspace'
  steps:
    - pre
  parameters:
    action: apply
    tfPath: C:\DEV\Onepoint\Smartplace\Infra.Templates\terraform\workspace
    prefixOutput: workspace
- task: azurecli
  displayName: 'Set azure rbac'
  steps:
    - pre
  parameters:
    scripttype: pwsh
    commandtype: inline
    script: | 
      $result = Get-Location
      $variables = Get-Content "$($result.path)/vars.json" | ConvertFrom-Json -Depth 100
      foreach ($rbac in $variables.'workspace.rbac') {
          $assignmentScope = $rbac.scope
          $principalName = $rbac.principalName
          $principalType = $rbac.principalType
          $roleDefinitionName = $rbac.role
          
          & "C:\DEV\Onepoint\Smartplace\Pipelines.Templates\steps\azure\rbac_azure.ps1" -assignmentScope "$assignmentScope" -principalName "$principalName" -principalType "$principalType" -roleDefinitionName "$roleDefinitionName"
      }
      Write-Host "Rbac apply with success!"
    storeVariablesInFile:
      format: json
      withSecrets: false