tasks:
- task: powershell
  displayName: 'Set scope name'
  steps:
    - pre
  parameters:
    type: inline
    script: |
      if("${{ scopeType }}" -eq "developer"){
        $reg = "${{ developerEmail }}" | Select-String -Pattern "${{ regex.developerEmail }}"
        $scopeName = "$($reg.Matches.Groups[1])$($reg.Matches.Groups[2])"
        if(!$scopeName){ 
          $scopeName = "$($reg.Matches.Groups[3])$($reg.Matches.Groups[4])".tolower() 
        }
        Write-Host "[lemniscat.pushvar] scope=d-$scopeName"
        Write-Host "[lemniscat.pushvar] ownerPrincipalType=user"
        Write-Host "[lemniscat.pushvar] ownerPrincipalName=${{ developerEmail }}"
      }
      if("${{ scopeType }}" -eq "team"){
        $reg = "${{ teamName }}" | Select-String -Pattern "${{ regex.teamName }}"
        $scopeName = "$($reg.Matches.Groups[1])$($reg.Matches.Groups[2])"
        if(!$scopeName){ 
          $scopeName = "$($reg.Matches.Groups[3])$($reg.Matches.Groups[4])".tolower() 
        }
        Write-Host "[lemniscat.pushvar] scope=t-$scopeName"
        Write-Host "[lemniscat.pushvar] ownerPrincipalType=group"
        Write-Host "[lemniscat.pushvar] ownerPrincipalName=${{ teamName }}"
      }
      if("${{ scopeType }}" -eq "program"){ 
        Write-Host "[lemniscat.pushvar] scopeName=${{ domain.code }}"
        Write-Host "[lemniscat.pushvar] ownerPrincipalType=group"
        Write-Host "[lemniscat.pushvar] ownerPrincipalName=${{ domaine.ADgroup }}"
      }
- task: powershell
  displayName: 'Set naming convention'
  steps:
    - pre
  parameters:
    type: inline
    script: |
      if("${{ appName }}" -ne ""){
        $tmp = "${{ appName }}"
        Write-Host "appName = $tmp"
        $CN = $tmp.tolower() -replace "-", ""
        Write-Host "Set additional variable : CN = $CN"
        Write-Host "[lemniscat.pushvar] CN=$CN"
      }

      if("${{ serviceLevel }}" -ne ""){
        $servicelevel = "${{ serviceLevel }}"
        $serviceLevelShort = "$($servicelevel.substring(0,1))$($servicelevel.substring($servicelevel.length-1,1))"
        Write-Host "Set additional variable : serviceLevelShort = $serviceLevelShort"
        Write-Host "[lemniscat.pushvar] serviceLevelShort=$serviceLevelShort" 
      } 

      if("${{ scope }}" -ne ""){
        $scopeShort = "${{ scope }}" -replace "-", "" 
        Write-Host "Set additional variable : scopeShort = $scopeShort"
        Write-Host "[lemniscat.pushvar] scopeShort=$scopeShort" 
      }
- task: filetransform
  displayName: 'Set tfvars'
  steps:
    - pre
  parameters:
    folderPath: C:\DEV\Onepoint\lemniscat\github\lemniscat.runtime\sample
    fileType: json
    targetFiles: "*.tfvars.json"
- task: powershell
  displayName: 'Show terraform parameter file'
  steps:
    - pre
  parameters:
    type: inline
    script: |
      cat C:\DEV\Onepoint\lemniscat\github\lemniscat.runtime\sample\variables.tfvars.json